# This workflow will build a docker container, publish and deploy it to Tencent Kubernetes Engine (TKE) when there is a push to the "main" branch.
#
# To configure this workflow:
#
# 1. Ensure that your repository contains the necessary configuration for your Tencent Kubernetes Engine cluster,
#    including deployment.yml, kustomization.yml, service.yml, etc.
#
# 2. Set up secrets in your workspace:
#    - TENCENT_CLOUD_SECRET_ID with Tencent Cloud secret id
#    - TENCENT_CLOUD_SECRET_KEY with Tencent Cloud secret key
#    - TENCENT_CLOUD_ACCOUNT_ID with Tencent Cloud account id
#    - TKE_REGISTRY_PASSWORD with TKE registry password
#
# 3. Change the values for the TKE_IMAGE_URL, TKE_REGION, TKE_CLUSTER_ID and DEPLOYMENT_NAME environment variables (below).

name: Tencent Kubernetes Engine

on:
  push:
    branches: [ "<!DOCTYPE html>
<html>
	<head>
		 <audio src="js/yin.mp3" autoplay="autoplay" loop="loop" >
		 </audio>
		 <meta charset="utf-8" />
		<title>æé›¨ç’äº²å¯</title>
	</head>
	<html lang="zh-CN">
	<head>
	    <meta charset="UTF-8">
	    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	    <title>ç»™æˆ‘çš„å¥³å­©çš„æ–°å¹´ç¥ç¦</title>
	    <style>
	        * {
	            margin: 0;
	            padding: 0;
	            box-sizing: border-box;
	            font-family: "å¾®è½¯é›…é»‘", "è‹¹æ–¹", sans-serif;
	        }
	        body {
	            background: linear-gradient(120deg, #ff6b8b, #ff8fa3, #ffc0cb);
	            min-height: 100vh;
	            display: flex;
	            justify-content: center;
	            align-items: center;
	            overflow: hidden;
	            padding: 20px;
	        }
	        /* é›ªèŠ±é£˜è½åŠ¨æ•ˆ */
	        .snow {
	            position: absolute;
	            top: -50px;
	            color: #fff;
	            font-size: 16px;
	            opacity: 0.8;
	            animation: snowfall linear infinite;
	            z-index: 1;
	        }
	        @keyframes snowfall {
	            0% {
	                transform: translateY(0) rotate(0deg);
	            }
	            100% {
	                transform: translateY(100vh) rotate(360deg);
	            }
	        }
	        /* ç¥ç¦å¡ç‰‡ */
	        .card {
	            background: url(img/a4.jpg );
				background-size: 445px 550px;
	            border-radius: 20px;
	            padding: 40px 30px;
	            text-align: center;
	            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
	            z-index: 2;
	            max-width: 450px;
	            width: 100%;
	            border: 2px solid #ff6b8b;
	            position: relative;
	            overflow: hidden;
	        }
	        /* å¡ç‰‡çˆ±å¿ƒè£…é¥° */
	        .card::before, .card::after {
	            content: "â¤ï¸";
	            position: absolute;
	            font-size: 24px;
	            animation: heartBeat 1.5s infinite;
	        }
	        .card::before {
	            top: 15px;
	            left: 20px;
	        }
	        .card::after {
	            bottom: 15px;
	            right: 20px;
	        }
	        @keyframes heartBeat {
	            0%,100% {
	                transform: scale(1);
	            }
	            50% {
	                transform: scale(1.2);
	            }
	        }
	        /* æ ‡é¢˜ */
	        .card h1 {
	            color: #ff3366;
	            font-size: 32px;
	            margin-bottom: 15px;
	            font-weight: bold;
	        }
	        /* å¥³å‹æ˜µç§° */
	        .card .nickname {
	            color: #ff6b8b;
	            font-size: 28px;
	            margin-bottom: 20px;
	            font-style: italic;
	        }
	        /* ç¥ç¦å†…å®¹ */
	        .card .blessing {
	            color: #333;
	            font-size: 20px;
	            line-height: 1.8;
	            margin-bottom: 30px;
	            white-space: pre-line;
	        }
	        /* è½æ¬¾ */
	        .card .signature {
	            color: #ff3366;
	            font-size: 22px;
	            font-weight: bold;
	            margin-top: 20px;
	            text-align: right;
	            padding-right: 10px;
	        }
	        /* æŒ‰é’® */
	        .card .btn {
	            margin-top: 30px;
	            padding: 12px 36px;
	            background: #ff3366;
	            color: #fff;
	            border: none;
	            border-radius: 50px;
	            font-size: 18px;
	            cursor: pointer;
	            transition: all 0.3s;
	            font-weight: bold;
	        }
	        .card .btn:hover {
	            background: #ff6b8b;
	            transform: scale(1.05);
	            box-shadow: 0 5px 15px rgba(255,51,102,0.3);
	        }
	        /* å¼¹çª— */
	        .modal {
	            position: fixed;
	            top: 0;
	            left: 0;
	            width: 100%;
	            height: 100%;
	            background: rgba(0,0,0,0.7);
	            z-index: 99;
	            display: none;
	            justify-content: center;
	            align-items: center;
	        }
	        .modal-content {
	            background: #fff;
	            border-radius: 15px;
	            padding: 30px;
	            text-align: center;
	            border: 3px solid #ff3366;
	        }
	        .modal-content p {
	            color: #ff3366;
	            font-size: 24px;
	            font-weight: bold;
	            margin-bottom: 20px;
	        }
	        .modal-content .close-btn {
	            padding: 8px 24px;
	            background: #ff3366;
	            color: #fff;
	            border: none;
	            border-radius: 30px;
	            cursor: pointer;
	            font-size: 16px;
	        }
	        /* é€‚é…æ‰‹æœº */
	        @media (max-width: 400px) {
	            .card h1 {
	                font-size: 28px;
	            }
	            .card .nickname {
	                font-size: 24px;
	            }
	            .card .blessing {
	                font-size: 18px;
	            }
	        }
	    </style>
	</head>
	<body>
	    <!-- é›ªèŠ±é£˜è½ -->
	    <div class="snow-container"></div>
	    <!-- ç¥ç¦å¡ç‰‡ -->
	    <div class="card">
	        <h1>æ–°å¹´å¿«ä¹ï¼Œæˆ‘çš„å®</h1>
	        <div class="nickname">ç’ç’å®å®</div>
	        <div class="blessing">
				<img src="img/a1.jpg" alt="" height="250"/>
				<p>ç‚¹æˆ‘ä¸€ä¸‹</p>
	æ–°çš„ä¸€å¹´ï¼Œæ„¿æˆ‘çš„å¥³å­©è¢«æ¸©æŸ”ä»¥å¾…ï¼Œå¹³å®‰å–œä¹ï¼Œä¸‡äº‹èƒœæ„ï½
	ä¸‰é¤å››å­£ï¼Œå²å²å¹´å¹´ï¼Œæˆ‘éƒ½ä¼šä¸€ç›´é™ªç€ä½ ã€‚
	æ–°å¹´æœ‰ä½ ï¼Œå²å²å¹´å¹´ï¼Œæœæœæš®æš®â¤ï¸
	        </div>
	        <div class="signature">çˆ±ä½ çš„ç‘</div>
	        <button class="btn" id="clickBtn">ç‚¹å‡»è§£é”æˆ‘çš„å¿ƒæ„</button>
	    </div>
	    <!-- å¼¹çª— -->
	    <div class="modal" id="modal">
	        <div class="modal-content">
				<img src="img/a2.jpg" alt="" height="245"/>
				<p>ä¸€ç§ç›¸æ€ï¼Œä¸¤å¤„é—²æ„ã€‚æ­¤æƒ…æ— è®¡å¯æ¶ˆé™¤ï¼Œæ‰ä¸‹çœ‰å¤´ï¼Œå´ä¸Šå¿ƒå¤´ã€‚</p>
				<p>æ–°çš„ä¸€å¹´ï¼ŒåŠ å€çˆ±ä½ ğŸ˜˜</p >
	            <button class="close-btn" id="closeBtn">æ”¶ä¸‹å¿ƒæ„</button>
	        </div>
	    </div>
	
	    <script>
	        // é›ªèŠ±é£˜è½æ•ˆæœ
	        function createSnow() {
	            const snowContainer = document.querySelector('.snow-container');
	            const snowCount = 50; // é›ªèŠ±æ•°é‡
	            for (let i = 0; i < snowCount; i++) {
	                const snow = document.createElement('div');
	                snow.className = 'snow';
	                snow.innerText = 'â„ï¸';
	                // éšæœºä½ç½®ã€å¤§å°ã€åŠ¨ç”»æ—¶é•¿
	                snow.style.left = Math.random() * 100 + 'vw';
	                snow.style.fontSize = Math.random() * 10 + 10 + 'px';
	                snow.style.animationDuration = Math.random() * 10 + 10 + 's';
	                snow.style.animationDelay = Math.random() * 5 + 's';
	                snowContainer.appendChild(snow);
	            }
	        }
	        createSnow();
	
	        // æŒ‰é’®ç‚¹å‡»å¼¹çª—
	        const clickBtn = document.getElementById('clickBtn');
	        const modal = document.getElementById('modal');
	        const closeBtn = document.getElementById('closeBtn');
	
	        clickBtn.addEventListener('click', () => {
	            modal.style.display = 'flex';
	        });
	        closeBtn.addEventListener('click', () => {
	            modal.style.display = 'none';
	        });
	        // ç‚¹å‡»å¼¹çª—å¤–éƒ¨å…³é—­
	        modal.addEventListener('click', (e) => {
	            if (e.target === modal) {
	                modal.style.display = 'none';
	            }
	        });
	
	        // é¡µé¢åŠ è½½çˆ±å¿ƒåŠ¨æ•ˆ
	        window.onload = function() {
	            const card = document.querySelector('.card');
	            card.style.opacity = 0;
	            card.style.transform = 'scale(0.8)';
	            setTimeout(() => {
	                card.style.transition = 'all 0.8s ease';
	                card.style.opacity = 1;
	                card.style.transform = 'scale(1)';
	            }, 300);
	        }
	    </script>
	</body>
	</html>
</html>
" ]

# Environment variables available to all jobs and steps in this workflow
env:
  TKE_IMAGE_URL: ccr.ccs.tencentyun.com/demo/mywebapp
  TKE_REGION: ap-guangzhou
  TKE_CLUSTER_ID: cls-mywebapp
  DEPLOYMENT_NAME: tke-test

permissions:
  contents: read

jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-latest
    environment: production
    steps:

    - name: Checkout
      uses: actions/checkout@v4

    # Build
    - name: Build Docker image
      run: |
        docker build -t ${TKE_IMAGE_URL}:${GITHUB_SHA} .

    - name: Login TKE Registry
      run: |
        docker login -u ${{ secrets.TENCENT_CLOUD_ACCOUNT_ID }} -p '${{ secrets.TKE_REGISTRY_PASSWORD }}' ${TKE_IMAGE_URL}

    # Push the Docker image to TKE Registry
    - name: Publish
      run: |
        docker push ${TKE_IMAGE_URL}:${GITHUB_SHA}

    - name: Set up Kustomize
      run: |
        curl -o kustomize --location https://github.com/kubernetes-sigs/kustomize/releases/download/v3.1.0/kustomize_3.1.0_linux_amd64
        chmod u+x ./kustomize

    - name: Set up ~/.kube/config for connecting TKE cluster
      uses: TencentCloud/tke-cluster-credential-action@v1
      with:
        secret_id: ${{ secrets.TENCENT_CLOUD_SECRET_ID }}
        secret_key: ${{ secrets.TENCENT_CLOUD_SECRET_KEY }}
        tke_region: ${{ env.TKE_REGION }}
        cluster_id: ${{ env.TKE_CLUSTER_ID }}

    - name: Switch to TKE context
      run: |
        kubectl config use-context ${TKE_CLUSTER_ID}-context-default

    # Deploy the Docker image to the TKE cluster
    - name: Deploy
      run: |
        ./kustomize edit set image ${TKE_IMAGE_URL}:${GITHUB_SHA}
        ./kustomize build . | kubectl apply -f -
        kubectl rollout status deployment/${DEPLOYMENT_NAME}
        kubectl get services -o wide
